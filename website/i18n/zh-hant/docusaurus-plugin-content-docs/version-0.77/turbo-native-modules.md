---
id: turbo-native-modules-introduction
title: 'Native Modules: Introduction'
---

import Tabs from '@theme/Tabs'; import TabItem from '@theme/TabItem'; import constants from '@site/core/TabsConstants';
import {TurboNativeModulesAndroid, TurboNativeModulesIOS} from './\_turbo-native-modules-components';

# 原生模組

您的 React Native 應用程式可能需要與 React Native 或現有函式庫未提供的原生平台 API 進行互動。您可以使用 **Turbo 原生模組**自行編寫整合程式碼。本指南將展示如何編寫此類模組。

基本步驟如下：

1. **使用 Flow 或 TypeScript 等熱門 JavaScript 類型註解語言定義類型化 JavaScript 規格**；
2. **配置您的依賴管理系統以執行 Codegen**，該工具會將規格轉換為原生語言介面；
3. **使用您的規格編寫應用程式程式碼**；以及
4. **使用生成的介面編寫原生平台程式碼**，將您的原生程式碼掛接到 React Native 執行環境中。

讓我們通過構建一個 Turbo 原生模組範例來逐步完成這些步驟。本指南的其餘部分假設您已使用以下命令創建了應用程式：

```shell
npx @react-native-community/cli@latest init TurboModuleExample --version 0.76.0
```

## 原生持久化儲存

本指南將展示如何實作 [Web Storage API](https://html.spec.whatwg.org/multipage/webstorage.html#dom-localstorage-dev) 的 `localStorage`。該 API 對於可能在您的專案上編寫應用程式程式碼的 React 開發者來說是熟悉的。

為了在行動裝置上實現此功能，我們需要使用 Android 和 iOS 的 API：

- Android: [SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences)，以及
- iOS: [NSUserDefaults](https://developer.apple.com/documentation/foundation/nsuserdefaults)。

### 1. 宣告類型化規格

React Native 提供了一個名為 [Codegen](/the-new-architecture/what-is-codegen.md) 的工具，該工具接受以 TypeScript 或 Flow 編寫的規格，並為 Android 和 iOS 生成平台特定的程式碼。該規格宣告了將在您的原生程式碼和 React Native JavaScript 執行環境之間傳遞的方法和資料類型。Turbo 原生模組既是您的規格，也是您編寫的原生程式碼，以及從您的規格生成的 Codegen 介面。

創建規格檔案的步驟如下：

1. 在您的應用程式的根目錄中，創建一個名為 `specs` 的新資料夾。
2. 創建一個名為 `NativeLocalStorage.ts` 的新檔案。

:::info
您可以在 [附錄](/appendix.md) 文件中查看所有可以在規格中使用的類型以及生成的原生類型。
:::

以下是 `localStorage` 規格的實作範例：

<Tabs groupId="language" queryString defaultValue={constants.defaultJavaScriptSpecLanguage} values={constants.javaScriptSpecLanguages}>
<TabItem value="typescript">

```typescript title="specs/NativeLocalStorage.ts"
import type {TurboModule} from 'react-native';
import {TurboModuleRegistry} from 'react-native';

export interface Spec extends TurboModule {
  setItem(value: string, key: string): void;
  getItem(key: string): string | null;
  removeItem(key: string): void;
  clear(): void;
}

export default TurboModuleRegistry.getEnforcing<Spec>(
  'NativeLocalStorage',
);
```

</TabItem>
<TabItem value="flow">

```flow title="NativeLocalStorage.js"
import type {TurboModule} from 'react-native';
import {TurboModule, TurboModuleRegistry} from 'react-native';

export interface Spec extends TurboModule {
  setItem(value: string, key: string): void;
  getItem(key: string): ?string;
  removeItem(key: string): void;
  clear(): void;
}
```

</TabItem>
</Tabs>

### 2. 配置 Codegen 執行

該規格由 React Native Codegen 工具使用，以生成平台特定的介面和樣板程式碼。為此，Codegen 需要知道在哪裡找到我們的規格以及如何處理它。更新您的 `package.json` 以包含以下內容：

```json title="package.json"
     "start": "react-native start",
     "test": "jest"
   },
   // highlight-add-start
   "codegenConfig": {
     "name": "NativeLocalStorageSpec",
     "type": "modules",
     "jsSrcsDir": "specs",
     "android": {
       "javaPackageName": "com.nativelocalstorage"
     }
   },
   // highlight-add-end
   "dependencies": {
```

在為 Codegen 配置好一切後，我們需要準備我們的原生程式碼以掛接到生成的程式碼中。

<Tabs groupId="platforms" queryString defaultValue={constants.defaultPlatform}>
<TabItem value="android" label="Android">
Codegen is executed through the `generateCodegenArtifactsFromSchema` Gradle task:

```bash
cd android
./gradlew generateCodegenArtifactsFromSchema

BUILD SUCCESSFUL in 837ms
14 actionable tasks: 3 executed, 11 up-to-date
```

This is automatically run when you build your Android application.
</TabItem>
<TabItem value="ios" label="iOS">
Codegen is run as part of the script phases that's automatically added to the project generated by CocoaPods.

```bash
cd ios
bundle install
bundle exec pod install
```

The output will look like this:

```shell
...
Framework build type is static library
[Codegen] Adding script_phases to ReactCodegen.
[Codegen] Generating ./build/generated/ios/ReactCodegen.podspec.json
[Codegen] Analyzing /Users/me/src/TurboModuleExample/package.json
[Codegen] Searching for codegen-enabled libraries in the app.
[Codegen] Found TurboModuleExample
[Codegen] Searching for codegen-enabled libraries in the project dependencies.
[Codegen] Found react-native
...
```

</TabItem>
</Tabs>

### 3. 使用 Turbo 原生模組編寫應用程式程式碼

使用 `NativeLocalStorage`，以下是修改後的 `App.tsx`，其中包含一些我們希望持久化的文字、一個輸入欄位和一些按鈕來更新此值。

`TurboModuleRegistry` 支援兩種檢索 Turbo 原生模組的模式：

- `get<T>(name: string): T | null`，如果 Turbo 原生模組不可用，則返回 `null`。
- `getEnforcing<T>(name: string): T`，如果 Turbo 原生模組不可用，則拋出異常。此模式假設模組始終可用。

```tsx title="App.tsx"
import React from 'react';
import {
  SafeAreaView,
  StyleSheet,
  Text,
  TextInput,
  Button,
} from 'react-native';

import NativeLocalStorage from './specs/NativeLocalStorage';

const EMPTY = '<empty>';

function App(): React.JSX.Element {
  const [value, setValue] = React.useState<string | null>(null);

  const [editingValue, setEditingValue] = React.useState<
    string | null
  >(null);

  React.useEffect(() => {
    const storedValue = NativeLocalStorage?.getItem('myKey');
    setValue(storedValue ?? '');
  }, []);

  function saveValue() {
    NativeLocalStorage?.setItem(editingValue ?? EMPTY, 'myKey');
    setValue(editingValue);
  }

  function clearAll() {
    NativeLocalStorage?.clear();
    setValue('');
  }

  function deleteValue() {
    NativeLocalStorage?.removeItem('myKey');
    setValue('');
  }

  return (
    <SafeAreaView style={{flex: 1}}>
      <Text style={styles.text}>
        Current stored value is: {value ?? 'No Value'}
      </Text>
      <TextInput
        placeholder="Enter the text you want to store"
        style={styles.textInput}
        onChangeText={setEditingValue}
      />
      <Button title="Save" onPress={saveValue} />
      <Button title="Delete" onPress={deleteValue} />
      <Button title="Clear" onPress={clearAll} />
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  text: {
    margin: 10,
    fontSize: 20,
  },
  textInput: {
    margin: 10,
    height: 40,
    borderColor: 'black',
    borderWidth: 1,
    paddingLeft: 5,
    paddingRight: 5,
    borderRadius: 5,
  },
});

export default App;
```

### 4. 編寫您的原生平台程式碼

在一切準備就緒後，我們將開始編寫原生平台程式碼。我們分為兩個部分進行：

:::note
本指南展示如何建立僅適用於新架構的 Turbo 原生模組。若需同時支援新架構與舊架構，請參閱我們的[向後相容性指南](https://github.com/reactwg/react-native-new-architecture/blob/main/docs/backwards-compat.md)。
:::

<Tabs groupId="platforms" queryString defaultValue={constants.defaultPlatform}>
    <TabItem value="android" label="Android">
        <TurboNativeModulesAndroid />
    </TabItem>
    <TabItem value="ios" label="iOS">
        <TurboNativeModulesIOS/>
    </TabItem>
</Tabs>